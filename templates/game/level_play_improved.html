{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 desktop-nav-level">
  <a href="{% url 'topic_levels' level.topic.id %}" class="btn btn-sm btn-outline-secondary">
    <i class="fa-solid fa-arrow-left me-1"></i>–ö —Ç–µ–º–µ
  </a>
  <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-primary">
    <i class="fa-solid fa-home me-1"></i>–î–∞—à–±–æ—Ä–¥
  </a>
</div>




<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —É—Ä–æ–≤–Ω—è -->
<div class="level-content">
  <form method="post" id="levelForm">
    {% csrf_token %}
    
    <!-- –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ -->
    {% if level.type == 'quiz' %}
      {% if quiz_data %}
        <!-- –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω —Å JSON -->
        <div class="quiz-container">
          <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã -->
          <div class="quiz-progress mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="quiz-status d-flex align-items-center gap-2">
                <!-- –ë–µ–π–¥–∂ —Å –≤–æ–ø—Ä–æ—Å–æ–º -->
                <span class="badge bg-primary fs-6">
                  <i class="fa-solid fa-question-circle me-2"></i>
                  –í–æ–ø—Ä–æ—Å {{ quiz_data.current_question_number }} –∏–∑ {{ quiz_data.total_questions }}
                </span>
                <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–ø—Ä–∞–≤–∞ -->
                <div class="quiz-hint-top">
                  {% if request.user.coins >= 3 %}
                    <button type="button" class="btn btn-outline-warning btn-sm hint-btn" onclick="showHint()">
                      <i class="fa-solid fa-lightbulb me-1"></i>–ü–æ–¥—Å–∫–∞–∑–∫–∞ (<span class="hint-coins">3ü™ô</span>)
                    </button>
                  {% else %}
                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled>
                      <i class="fa-solid fa-lightbulb me-1"></i>–ü–æ–¥—Å–∫–∞–∑–∫–∞ (<span class="hint-coins">3ü™ô</span>) - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç
                    </button>
                  {% endif %}
                </div>
          </div>
        </div>
            
            <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
            <div class="container-fluid px-0">
              <div class="progress quiz-progress-bar" style="height: 12px; border-radius: 6px; overflow: hidden;">
                <div class="progress-bar progress-bar-striped" 
                     role="progressbar" 
                     id="quizProgressBar"
                     data-answered="{{ quiz_data.current_question }}"
                     data-total="{{ quiz_data.total_questions }}">
                  <span class="progress-text">{{ quiz_data.current_question }}/{{ quiz_data.total_questions }}</span>
                </div>
              </div>
            </div>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤–Ω–∏–∑—É -->
            <div id="hintContent" class="mt-2 hint-container" style="display: none;">
              <div class="hint-card">
                <div class="hint-icon">
                  <i class="fa-solid fa-lightbulb"></i>
                </div>
                <div class="hint-text">
                  {{ quiz_data.current_question_data.hint|default:"–ü–æ–¥—É–º–∞–π—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–¥ –∫–∞–∂–¥—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º –æ—Ç–≤–µ—Ç–∞!" }}
                </div>
              </div>
            </div>
      </div>
          
            <!-- –¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å -->
            <!-- DEBUG: current_question = {{ quiz_data.current_question }}, total_questions = {{ quiz_data.total_questions }}, answered_questions = {{ quiz_data.answered_questions }} -->
            {% if quiz_data.current_question_data %}
              <div class="question-block mb-4" data-question="{{ quiz_data.current_question }}">
                <div class="card quiz-card">
                  <div class="card-header quiz-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                          <i class="fa-solid fa-brain me-2"></i>
                          –í–æ–ø—Ä–æ—Å {{ quiz_data.current_question_number }}
                        </h5>
                      <div class="question-difficulty">
                        {% if level.difficulty == 1 %}
                          <span class="badge bg-success"><i class="fa-solid fa-star me-1"></i>–õ–µ–≥–∫–æ</span>
                        {% elif level.difficulty == 2 %}
                          <span class="badge bg-warning"><i class="fa-solid fa-star me-1"></i><i class="fa-solid fa-star me-1"></i>–°—Ä–µ–¥–Ω–µ</span>
                        {% else %}
                          <span class="badge bg-danger"><i class="fa-solid fa-star me-1"></i><i class="fa-solid fa-star me-1"></i><i class="fa-solid fa-star me-1"></i>–°–ª–æ–∂–Ω–æ</span>
                        {% endif %}
    </div>
  </div>
</div>

                  <div class="card-body quiz-body">
                    <div class="question-text mb-3">
                      <div class="question-icon mb-2">
                        <i class="fa-solid fa-lightbulb"></i>
                      </div>
                      <p class="lead question-content">{{ quiz_data.current_question_data.question }}</p>
                    </div>
                    
                    <div class="quiz-options">
                      {% if quiz_data.current_question_data.type == 'multiple' %}
                        <div class="alert alert-info mb-3">
                          <i class="fa-solid fa-info-circle me-2"></i>
                          <strong>–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä:</strong> –í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
                        </div>
                        {% for option in quiz_data.current_question_data.options %}
                          <div class="form-check quiz-option mb-3">
                            <input class="form-check-input quiz-radio" type="checkbox" name="answers" value="{{ forloop.counter0 }}" id="option_{{ quiz_data.current_question }}_{{ forloop.counter0 }}">
                            <label class="form-check-label quiz-label" for="option_{{ quiz_data.current_question }}_{{ forloop.counter0 }}">
                              <div class="option-content">
                                <div class="option-letter">{% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% else %}{{ forloop.counter }}{% endif %}</div>
                                <div class="option-text">{{ option.text }}</div>
                              </div>
                            </label>
                          </div>
                        {% endfor %}
                      {% elif quiz_data.current_question_data.type == 'matching' %}
                        <!-- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ -->
                        <div class="matching-container">
                          <!-- –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è: drag and drop -->
                          <div class="matching-desktop">
                          <div class="alert alert-info mb-3">
                            <i class="fa-solid fa-link me-2"></i>
                            <strong>–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:</strong> –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω—ã –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–ø–∏—Å–∞–Ω–∏—è–º
                          </div>
                          <div class="row">
                            <!-- –¢–µ—Ä–º–∏–Ω—ã (draggable) -->
                            <div class="col-md-6">
                              <h6 class="mb-3"><i class="fa-solid fa-list me-2"></i>–¢–µ—Ä–º–∏–Ω—ã (–ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ):</h6>
                              <div class="matching-left">
                                {% for left_item in quiz_data.current_question_data.left_items %}
                                  <div class="matching-draggable mb-3" 
                                       data-left-index="{{ forloop.counter0 }}"
                                       draggable="true">
                                    <div class="card">
                                      <div class="card-body">
                                        <i class="fa-solid fa-grip-vertical me-2 text-muted"></i>
                                        {{ left_item }}
                                      </div>
                                    </div>
                                  </div>
                                {% endfor %}
                              </div>
                            </div>
                            <!-- –û–ø–∏—Å–∞–Ω–∏—è (drop zones) -->
                            <div class="col-md-6">
                              <h6 class="mb-3"><i class="fa-solid fa-book me-2"></i>–û–ø–∏—Å–∞–Ω–∏—è:</h6>
                              <div class="matching-right">
                                {% for right_item in quiz_data.current_question_data.right_items %}
                                  <div class="matching-drop-zone mb-3" 
                                       data-right-index="{{ forloop.counter0 }}">
                                    <div class="card h-100">
                                      <div class="card-body">
                                        <div class="right-item-text mb-2"><small class="text-muted">{{ right_item }}</small></div>
                                        <hr>
                                        <span class="drop-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω —Å—é–¥–∞</span>
                                      </div>
                                    </div>
                                    <input type="hidden" name="match_{{ forloop.counter0 }}" value="" id="hidden_match_{{ forloop.counter0 }}">
                                  </div>
                                {% endfor %}
                              </div>
                              </div>
                            </div>
                          </div>
                          
                          <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ -->
                          <div class="matching-mobile">
                            <div class="alert alert-info mb-3">
                              <i class="fa-solid fa-link me-2"></i>
                              <strong>–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:</strong> –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞
                            </div>
                            <div class="matching-cards-mobile">
                              {% for left_item in quiz_data.current_question_data.left_items %}
                                <div class="matching-card-mobile mb-3">
                                  <div class="matching-term-mobile">
                                    <span class="term-number-mobile">{{ forloop.counter }}</span>
                                    <span class="term-text-mobile">{{ left_item }}</span>
                                  </div>
                                  <div class="matching-select-wrapper-mobile">
                                    <label class="form-label small text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
                                    <select name="match_{{ forloop.counter0 }}" class="form-select matching-select-mobile" required>
                                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                                      {% for right_item in quiz_data.current_question_data.right_items %}
                                        <option value="{{ forloop.counter0 }}">{{ right_item }}</option>
                                      {% endfor %}
                                    </select>
                                  </div>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                        </div>
                      {% elif quiz_data.current_question_data.type == 'sorting' %}
                        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                        <div class="sorting-container">
                          <div class="alert alert-info mb-3">
                            <i class="fa-solid fa-sort me-2"></i>
                            <strong>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</strong> –†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                          </div>
                          <ul id="sortable-list_{{ quiz_data.current_question }}" class="list-group">
                            {% for item in quiz_data.current_question_data.items %}
                              <li class="list-group-item" data-id="{{ item.id }}" draggable="true">
                                <i class="fa-solid fa-grip-vertical me-2 handle"></i>
                                {{ item.text }}
                              </li>
                            {% endfor %}
                          </ul>
                        </div>
                      {% else %}
                        <!-- –û–±—ã—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (single) -->
                        {% for option in quiz_data.current_question_data.options %}
                          <div class="form-check quiz-option mb-3">
                            <input class="form-check-input quiz-radio" 
                                   type="radio" 
                                   name="answer" 
                                   value="{{ forloop.counter0 }}" 
                                   id="option_{{ quiz_data.current_question }}_{{ forloop.counter0 }}">
                            <label class="form-check-label quiz-label" 
                                   for="option_{{ quiz_data.current_question }}_{{ forloop.counter0 }}">
                              <div class="option-content">
                                <div class="option-letter">{% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% elif forloop.counter == 4 %}D{% elif forloop.counter == 5 %}E{% else %}{{ forloop.counter }}{% endif %}</div>
                                <div class="option-text">{{ option.text }}</div>
                              </div>
                            </label>
                          </div>
                        {% endfor %}
                      {% endif %}
                    </div>
                    
                     <input type="hidden" name="question_index" value="{{ quiz_data.current_question }}">
                     <input type="hidden" name="completion_time" id="completionTime" value="0">
                  </div>
                  
                  <div class="card-footer quiz-footer">
                    <div class="d-flex justify-content-center align-items-center">
                      <div class="quiz-actions">
                        <button type="button" class="btn btn-primary btn-lg quiz-submit" id="quizSubmitBtn">
                          <i class="fa-solid fa-check me-2"></i>
                          {% if quiz_data.current_question_number == quiz_data.total_questions %}
                            –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
                          {% else %}
                            –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
                          {% endif %}
                        </button>
                      </div>
                    </div>
                </div>
              </div>
            {% endif %}
        </div>
      {% else %}
        <!-- –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω —Å LevelOption -->
        <div class="quiz-container">
          {% for question_num in level.options.values_list.question_number.distinct %}
            <div class="question-block mb-4" data-question="{{ question_num }}">
      <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">–í–æ–ø—Ä–æ—Å {{ question_num }}</h5>
                </div>
        <div class="card-body">
                  <div class="question-text mb-3">
                    {% if level.content.questions %}
                      {% for question in level.content.questions %}
                        {% if forloop.counter == question_num %}
                          <p class="lead">{{ question.text }}</p>
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      <p class="lead">–í–æ–ø—Ä–æ—Å {{ question_num }}</p>
                    {% endif %}
                  </div>
                  
          <div class="quiz-options">
            {% for option in level.options.all %}
                      {% if option.question_number == question_num %}
              <div class="form-check mb-3">
                          <input class="form-check-input" type="radio" name="answer_{{ question_num }}" value="{{ option.id }}" id="option_{{ option.id }}">
                <label class="form-check-label" for="option_{{ option.id }}">
                  {{ option.text }}
                </label>
              </div>
                      {% endif %}
            {% endfor %}
          </div>
                  
                  <div class="hint-section mt-3" style="display: none;">
                    <div class="alert alert-info">
                      <i class="fa-solid fa-lightbulb me-2"></i>
                      <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong>
                      <span class="hint-text">
                        {% if level.content.questions %}
                          {% for question in level.content.questions %}
                            {% if forloop.counter == question_num %}
                              {{ question.hint }}
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                      </span>
        </div>
      </div>
    
                  <button type="button" class="btn btn-outline-secondary btn-sm show-hint-btn">
                    <i class="fa-solid fa-lightbulb me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
                  </button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    
    <!-- –¢–µ—Å—Ç —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ -->
    {% elif level.type == 'test' %}
      <div class="test-container">
        {% for question_num in level.options.values_list.question_number.distinct %}
          <div class="question-block mb-4" data-question="{{ question_num }}">
      <div class="card">
              <div class="card-header">
                <h5 class="mb-0">–í–æ–ø—Ä–æ—Å {{ question_num }}</h5>
              </div>
        <div class="card-body">
                <div class="question-text mb-3">
                  {% if level.content.questions %}
                    {% for question in level.content.questions %}
                      {% if forloop.counter == question_num %}
                        <p class="lead">{{ question.text }}</p>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <p class="lead">–í–æ–ø—Ä–æ—Å {{ question_num }}</p>
                  {% endif %}
                </div>
                
          <div class="test-options">
            {% for option in level.options.all %}
                    {% if option.question_number == question_num %}
              <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="answer_{{ question_num }}" value="{{ option.id }}" id="option_{{ option.id }}">
                <label class="form-check-label" for="option_{{ option.id }}">
                  {{ option.text }}
                </label>
              </div>
                    {% endif %}
            {% endfor %}
          </div>
                
                <div class="hint-section mt-3" style="display: none;">
                  <div class="alert alert-info">
                    <i class="fa-solid fa-lightbulb me-2"></i>
                    <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong>
                    <span class="hint-text">
                      {% if level.content.questions %}
                        {% for question in level.content.questions %}
                          {% if forloop.counter == question_num %}
                            {{ question.hint }}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    </span>
        </div>
      </div>
    
                <button type="button" class="btn btn-outline-secondary btn-sm show-hint-btn">
                  <i class="fa-solid fa-lightbulb me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
                      </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    
    <!-- –†–∞—Å—á–µ—Ç—ã -->
    {% elif level.type == 'calculation' %}
      <div class="calculation-container">
        {% for question_data in level.content.questions %}
          <div class="question-block mb-4">
      <div class="card">
              <div class="card-header">
                <h5 class="mb-0">–ó–∞–¥–∞—á–∞ {{ forloop.counter }}</h5>
              </div>
        <div class="card-body">
                <div class="question-text mb-3">
                  <p class="lead">{{ question_data.question }}</p>
            </div>
            
                <div class="calculation-input">
                  <div class="mb-3">
                    <label for="calculation_answer_{{ forloop.counter }}" class="form-label">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                    <input type="number" class="form-control" name="calculation_answer_{{ forloop.counter }}" id="calculation_answer_{{ forloop.counter }}" step="0.01" required>
        </div>
      </div>
    
                <div class="hint-section mt-3" style="display: none;">
                <div class="alert alert-info">
                  <i class="fa-solid fa-lightbulb me-2"></i>
                    <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong>
                    <span class="hint-text">{{ question_data.hint }}</span>
                </div>
            </div>
            
                <button type="button" class="btn btn-outline-secondary btn-sm show-hint-btn">
                  <i class="fa-solid fa-lightbulb me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
                </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    
    <!-- –ö–≤–µ—Å—Ç -->
    {% elif level.type == 'quest' %}
      <div class="quest-container">
      <div class="card">
          <div class="card-header">
            <h5 class="mb-0">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∫–≤–µ—Å—Ç</h5>
          </div>
        <div class="card-body">
            <div class="quest-content">
              <div class="quest-description mb-4">
                <p>{{ level.content.description }}</p>
            </div>
            
              <div class="quest-steps">
                {% for step_num, step_data in level.content.steps.items %}
                  <div class="quest-step mb-4" data-step="{{ step_num }}">
                    <div class="card">
                      <div class="card-header">
                        <h6 class="mb-0">–®–∞–≥ {{ step_num }}</h6>
                      </div>
                      <div class="card-body">
                        <p class="mb-3">{{ step_data.description }}</p>
                        
                        <div class="quest-options">
                          {% for option in step_data.options %}
                <div class="form-check mb-3">
                              <input class="form-check-input" type="radio" name="quest_answer_{{ step_num }}" value="{{ forloop.counter0 }}" id="quest_option_{{ step_num }}_{{ forloop.counter0 }}">
                              <label class="form-check-label" for="quest_option_{{ step_num }}_{{ forloop.counter0 }}">
                                {{ option.text }}
                  </label>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
                {% endfor %}
            </div>
            </div>
          </div>
        </div>
      </div>
    
    <!-- –ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞ -->
    {% elif level.type == 'puzzle' %}
      <div class="puzzle-container">
      <div class="card">
          <div class="card-header">
            <h5 class="mb-0">–ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞</h5>
          </div>
        <div class="card-body">
            <div class="puzzle-text mb-4">
              <p class="lead">{{ level.content.puzzle_text }}</p>
                  </div>
            
            <div class="puzzle-input">
              <div class="mb-3">
                <label for="puzzle_answer" class="form-label">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                <input type="text" class="form-control" name="puzzle_answer" id="puzzle_answer" required>
              </div>
                  </div>
            
            <div class="hint-section mt-3" style="display: none;">
              <div class="alert alert-info">
                <i class="fa-solid fa-lightbulb me-2"></i>
                <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong>
                <span class="hint-text">{{ level.content.hint }}</span>
              </div>
            </div>
            
            <button type="button" class="btn btn-outline-secondary btn-sm show-hint-btn">
              <i class="fa-solid fa-lightbulb me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
            </button>
            </div>
          </div>
        </div>
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è —Å –≤—ã–±–æ—Ä–æ–º -->
    {% elif level.type == 'story' %}
      <div class="story-container">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">–ò—Å—Ç–æ—Ä–∏—è —Å –≤—ã–±–æ—Ä–æ–º</h5>
          </div>
          <div class="card-body">
            <div class="story-text mb-4">
              <p class="lead">{{ level.content.story_text }}</p>
      </div>
    
            <div class="story-questions">
              {% for question in level.content.questions %}
                <div class="question-block mb-4">
      <div class="card">
                    <div class="card-header">
                      <h6 class="mb-0">–í–æ–ø—Ä–æ—Å {{ forloop.counter }}</h6>
                    </div>
        <div class="card-body">
                      <p class="mb-3">{{ question.question }}</p>
                      
                      <div class="story-options">
                        {% for option in question.options %}
                          <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="story_answer_{{ forloop.parentloop.counter }}" value="{{ forloop.counter0 }}" id="story_option_{{ forloop.parentloop.counter }}_{{ forloop.counter0 }}">
                            <label class="form-check-label" for="story_option_{{ forloop.parentloop.counter }}_{{ forloop.counter0 }}">
                              {{ option.text }}
                            </label>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
    
    <!-- –°—Ü–µ–Ω–∞—Ä–∏–π -->
    {% elif level.type == 'scenario' %}
      <div class="scenario-container">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">–°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π</h5>
          </div>
          <div class="card-body">
            <div class="scenario-text mb-4">
              <p class="lead">{{ level.content.scenario_text }}</p>
      </div>
    
            <div class="scenario-options">
              {% for option in level.content.options %}
                <div class="form-check mb-3">
                  <input class="form-check-input" type="radio" name="scenario_answer" value="{{ forloop.counter0 }}" id="scenario_option_{{ forloop.counter0 }}">
                  <label class="form-check-label" for="scenario_option_{{ forloop.counter0 }}">
                    {{ option.text }}
                  </label>
                </div>
              {% endfor %}
            </div>
            
            <div class="hint-section mt-3" style="display: none;">
              <div class="alert alert-info">
                <i class="fa-solid fa-lightbulb me-2"></i>
                <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong>
                <span class="hint-text">{{ level.content.hint }}</span>
              </div>
            </div>
            
            <button type="button" class="btn btn-outline-secondary btn-sm show-hint-btn">
              <i class="fa-solid fa-lightbulb me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
            </button>
          </div>
        </div>
      </div>
    
    <!-- –°–∏–º—É–ª—è—Ü–∏—è -->
    {% elif level.type == 'simulation' %}
      <div class="simulation-container">
      <div class="card">
          <div class="card-header">
            <h5 class="mb-0">–°–∏–º—É–ª—è—Ü–∏—è</h5>
          </div>
        <div class="card-body">
            <div class="simulation-content">
              {% for scenario in level.content.scenarios %}
                <div class="simulation-scenario mb-4">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="mb-0">{{ scenario.title }}</h6>
              </div>
                    <div class="card-body">
                      <p class="mb-3">{{ scenario.description }}</p>
              
                      <div class="simulation-options">
                        {% for option in scenario.options %}
                  <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="simulation_answer_{{ forloop.parentloop.counter }}" value="{{ forloop.counter0 }}" id="simulation_option_{{ forloop.parentloop.counter }}_{{ forloop.counter0 }}">
                            <label class="form-check-label" for="simulation_option_{{ forloop.parentloop.counter }}_{{ forloop.counter0 }}">
                              {{ option.text }}
                    </label>
                  </div>
                {% endfor %}
              </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}
    
    {% if level.type != 'quiz' %}
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-primary btn-lg">
        <i class="fa-solid fa-check me-2"></i>–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å
      </button>
    </div>
    {% endif %}
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–∫–∞–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫
    document.querySelectorAll('.show-hint-btn').forEach(button => {
        button.addEventListener('click', function() {
            const hintSection = this.parentElement.querySelector('.hint-section');
            if (hintSection.style.display === 'none') {
                hintSection.style.display = 'block';
                this.innerHTML = '<i class="fa-solid fa-eye-slash me-1"></i>–°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É';
            } else {
                hintSection.style.display = 'none';
                this.innerHTML = '<i class="fa-solid fa-lightbulb me-1"></i>–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É';
            }
        });
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    function updateProgress() {
        const totalQuestions = document.querySelectorAll('.question-block').length;
        const answeredQuestions = document.querySelectorAll('.question-block input:checked').length;
        const progress = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
        const progressBar = document.getElementById('progressBar');
        if (progressBar) {
            progressBar.style.width = progress + '%';
        }
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤
    document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
        input.addEventListener('change', updateProgress);
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    updateProgress();
});
</script>

<style>
.question-block {
    transition: all 0.3s ease;
}

.question-block:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.quiz-options .form-check-input,
.test-options .form-check-input {
  transform: scale(1.2);
}

.hint-section {
    transition: all 0.3s ease;
}

.level-type-icon {
    font-size: 2rem;
}

.quest-step {
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.quest-step.active {
    opacity: 1;
}

.simulation-scenario {
    border-left: 4px solid #007bff;
}

.scenario-container .form-check-input:checked + .form-check-label {
    background-color: #e3f2fd;
    padding: 8px;
    border-radius: 4px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è drag & drop —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è */
.matching-draggable {
    cursor: grab;
    transition: all 0.2s ease;
    user-select: none;
    margin-bottom: 20px;
}

.matching-draggable .card {
    border: 2px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}

.matching-draggable:active {
    cursor: grabbing;
}

.matching-draggable:hover {
    transform: translateY(-2px);
}

.matching-draggable:hover .card {
    border-color: #9c27b0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è drop zone */
.matching-drop-zone {
    min-height: 90px;
    transition: all 0.3s ease;
    cursor: default;
    position: relative;
    padding: 0;
    margin-bottom: 24px;
}

.matching-drop-zone .card {
    min-height: 90px;
    height: 100%;
    border: 2px solid #e0e0e0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

.matching-drop-zone input[type="hidden"] {
    position: absolute;
    pointer-events: none;
}

.matching-drop-zone.drop-active {
    background-color: #f3e5f5 !important;
    border: 3px solid #9c27b0 !important;
    border-radius: 12px;
    transform: scale(1.02);
}

.matching-drop-zone.drop-active .card {
    background-color: #f3e5f5 !important;
    border: 3px dashed #9c27b0 !important;
    border-radius: 12px;
}

.matching-drop-zone.matched {
    background-color: #e1bee7 !important;
    border: 1px solid #7b1fa2 !important;
    border-radius: 12px;
}

.matching-drop-zone.matched .card {
    background-color: #e1bee7 !important;
    border: 1px solid #7b1fa2 !important;
    border-radius: 12px;
}

.matching-drop-zone.matched .card-body {
    color: #4a148c;
}

/* –¢–µ–∫—Å—Ç –≤ drop zone */
.drop-text {
    font-style: italic;
    color: #999;
}

.right-item-text {
    font-weight: 500;
    color: #495057;
}

.matching-drop-zone.matched .right-item-text {
    color: #2e7d32;
    font-weight: bold;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è draggable —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
.matching-draggable.matched {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
    filter: grayscale(100%);
}

.matching-draggable.matched .card {
    background-color: #e0e0e0;
    color: #757575;
    border-color: #bdbdbd;
}

/* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
.matching-container .card {
    user-select: none;
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ */
.matching-container h6 {
    font-weight: 600;
    color: #495057;
    padding-bottom: 12px;
    border-bottom: 2px solid #e9ecef;
    margin-bottom: 20px;
}

.matching-container .col-md-6:first-child {
    border-right: 2px dashed #dee2e6;
    padding-right: 24px;
}

.matching-container .col-md-6:last-child {
    padding-left: 24px;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã */
.matching-left, .matching-right {
    padding-top: 8px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
.sorting-container .list-group {
    max-width: 600px;
    margin: 0 auto;
}

.sorting-container .list-group-item {
    cursor: grab;
    transition: all 0.2s ease;
    margin-bottom: 16px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.06);
}

.sorting-container .list-group-item:hover {
    transform: translateX(4px);
    border-color: #6366f1;
    box-shadow: 0 3px 6px rgba(99, 102, 241, 0.15);
}

.sorting-container .list-group-item:active {
    cursor: grabbing;
    transform: scale(1.02);
}

.sorting-container .list-group-item .handle {
    color: #6c757d;
    margin-right: 12px;
}

.sorting-container .list-group-item:last-child {
    margin-bottom: 0;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
.hint-btn {
    transition: all 0.3s ease;
    color: #ffc107 !important;
    background-color: transparent;
    text-shadow: none !important;
}

.hint-coins {
    color: #ffc107;
    transition: color 0.3s ease;
}

.hint-btn:hover .hint-coins {
    color: white;
}

.hint-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    color: white !important;
    background-color: #ffc107 !important;
    border-color: #ffc107;
    text-shadow: none !important;
}

.hint-btn:active,
.hint-btn:focus {
    color: white !important;
    background-color: #ffc107 !important;
    border-color: #ffc107;
    text-shadow: none !important;
}

/* –ö–æ–≥–¥–∞ –∫–Ω–æ–ø–∫–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "–°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É" */
.hint-btn.btn-warning {
    color: white !important;
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
    text-shadow: none !important;
}

.hint-btn.btn-warning:hover {
    color: #ffc107 !important;
    background-color: transparent !important;
    border-color: #ffc107 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    text-shadow: none !important;
}

.hint-container {
    animation: slideDown 0.3s ease-out;
    transition: opacity 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.hint-card {
    position: relative;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 24px;
    color: white;
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.hint-icon {
    text-align: center;
    margin-bottom: 16px;
    font-size: 48px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.8;
    }
}

.hint-text {
    font-size: 16px;
    line-height: 1.6;
    text-align: center;
    font-weight: 500;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

/* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
@media (max-width: 768px) {
  /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
  body.mobile-view .desktop-nav-level {
    display: none !important;
  }
  
  /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤ —Å—Ç–∏–ª–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
  body.mobile-view .quiz-progress {
    margin-bottom: 0.75rem !important;
    padding: 0.75rem !important;
    background: white !important;
    border-radius: 16px !important;
    border: 1px solid rgba(0, 0, 0, 0.08) !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
  }
  
  body.dark-theme .quiz-progress {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(51, 65, 85, 0.92) 100%) !important;
    border-color: #475569 !important;
  }
  
  body.mobile-view .quiz-status {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 0.4rem !important;
    margin-bottom: 0.5rem !important;
  }
  
  body.mobile-view .quiz-status .badge {
    font-size: 0.7rem !important;
    padding: 0.25rem 0.5rem !important;
  }
  
  body.mobile-view .quiz-status .text-muted {
    font-size: 0.65rem !important;
    margin-left: 0 !important;
  }
  
  body.mobile-view .quiz-progress-bar {
    height: 6px !important;
    border-radius: 10px !important;
    background: rgba(0, 0, 0, 0.1) !important;
    overflow: hidden !important;
    margin-bottom: 0.5rem !important;
  }
  
  body.dark-theme .quiz-progress-bar {
    background: rgba(255, 255, 255, 0.1) !important;
  }
  
  body.mobile-view .quiz-progress-bar .progress-bar {
    background: linear-gradient(90deg, #667eea, #764ba2) !important;
    border-radius: 10px !important;
    height: 100% !important;
    transition: width 0.8s ease !important;
    background-image: none !important; /* –£–±–∏—Ä–∞–µ–º –ø–æ–ª–æ—Å—ã (striped) */
  }
  
  body.mobile-view .quiz-progress-bar .progress-text {
    display: none !important;
  }
  
  body.mobile-view .quiz-progress small {
    font-size: 0.65rem !important;
  }
  
  body.mobile-view .quiz-footer {
    padding: 0.75rem !important;
  }
  
  body.mobile-view .quiz-actions {
    width: 100% !important;
    display: flex !important;
    justify-content: center !important;
  }
  
  body.mobile-view .quiz-submit {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 auto !important;
  }
  
  body.mobile-view .quiz-hint-top {
    margin-bottom: 1rem !important;
  }
  
  body.mobile-view .hint-btn {
    font-size: 0.8rem !important;
    padding: 0.5rem 0.75rem !important;
  }
  
  /* –°–∫—Ä—ã–≤–∞–µ–º –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –≤–µ—Ä—Å–∏—é —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è */
  body.mobile-view .matching-desktop {
    display: none !important;
  }
  
  /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è */
  body.mobile-view .matching-mobile {
    display: block !important;
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è */
  body.mobile-view .matching-card-mobile {
    background: white;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: 16px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }
  
  body.dark-theme .matching-card-mobile {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(51, 65, 85, 0.92) 100%);
    border-color: #475569;
  }
  
  body.mobile-view .matching-term-mobile {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
  }
  
  body.dark-theme .matching-term-mobile {
    border-bottom-color: #475569;
  }
  
  body.mobile-view .term-number-mobile {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.9rem;
    flex-shrink: 0;
  }
  
  body.mobile-view .term-text-mobile {
    font-size: 0.95rem;
    font-weight: 600;
    flex: 1;
  }
  
  body.mobile-view .matching-select-wrapper-mobile {
    margin-top: 0.5rem !important;
  }
  
  body.mobile-view .matching-select-wrapper-mobile .form-label {
    font-size: 0.7rem !important;
    margin-bottom: 0.4rem !important;
    color: #6b7280 !important;
    font-weight: 500 !important;
  }
  
  body.dark-theme .matching-select-wrapper-mobile .form-label {
    color: #94a3b8 !important;
  }
  
  body.mobile-view .matching-select-mobile {
    font-size: 0.8rem !important;
    padding: 0.6rem 0.75rem !important;
    border-radius: 12px !important;
    border: 1.5px solid rgba(102, 126, 234, 0.3) !important;
    background: white !important;
    color: #1f2937 !important;
    font-weight: 500 !important;
    transition: all 0.2s ease !important;
    appearance: none !important;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E") !important;
    background-repeat: no-repeat !important;
    background-position: right 0.75rem center !important;
    background-size: 12px !important;
    padding-right: 2.5rem !important;
  }
  
  body.dark-theme .matching-select-mobile {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(51, 65, 85, 0.92) 100%) !important;
    border-color: #475569 !important;
    color: #f1f5f9 !important;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a5b4fc' d='M6 9L1 4h10z'/%3E%3C/svg%3E") !important;
    background-repeat: no-repeat !important;
    background-position: right 0.75rem center !important;
    background-size: 12px !important;
  }
  
  body.mobile-view .matching-select-mobile:focus {
    border-color: #667eea !important;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    outline: none !important;
  }
  
  body.mobile-view .matching-select-mobile option {
    padding: 0.5rem !important;
    font-size: 0.8rem !important;
  }
}

/* –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è: —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—É—é */
.matching-mobile {
  display: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –¢–∞–π–º–µ—Ä –¥–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
    let timeLeft = 0;
    let timerInterval;
    
    function startTimer() {
        timeLeft = 0;
        timerInterval = setInterval(function() {
            timeLeft++;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerElement = document.getElementById('timer');
            if (timerElement) {
                timerElement.textContent = 
                    (minutes < 10 ? '0' : '') + minutes + ':' + 
                    (seconds < 10 ? '0' : '') + seconds;
            }
        }, 1000);
    }
    
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    startTimer();
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ—Ç–≤–µ—Ç–∞
    const radioButtons = document.querySelectorAll('.quiz-radio');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¢–û–õ–¨–ö–û –¥–ª—è radio (–Ω–µ –¥–ª—è checkbox)
            if (this.type === 'radio') {
                radioButtons.forEach(rb => {
                    if (rb !== this && rb.type === 'radio') {
                        rb.checked = false;
                    }
                });
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
            const label = this.nextElementSibling;
            if (label) {
                label.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    label.style.transform = 'scale(1.02)';
                }, 150);
            }
    });
  });
  
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
    const optionLabels = document.querySelectorAll('.quiz-label');
    optionLabels.forEach(label => {
        label.addEventListener('mouseenter', function() {
            if (!this.querySelector('.quiz-radio').checked) {
                this.style.transform = 'scale(1.02)';
            }
        });
        
        label.addEventListener('mouseleave', function() {
            if (!this.querySelector('.quiz-radio').checked) {
                this.style.transform = 'scale(1)';
      }
    });
  });
    
           // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
           const form = document.getElementById('levelForm');
           if (form) {
               // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ ID
              const submitButton = document.getElementById('quizSubmitBtn');
              if (submitButton) {
                  submitButton.addEventListener('click', function(e) {
                      e.preventDefault();
                      e.stopPropagation();
                      
                      // –ü—Ä–æ–≤–µ—Ä–∫–∞ matching (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏)
                      const matchingDesktop = document.querySelector('.matching-desktop');
                      if (matchingDesktop && matchingDesktop.offsetParent !== null) {
                      const matchingContainer = document.querySelector('.matching-container');
                      if (matchingContainer) {
                          const totalDropZones = matchingContainer.querySelectorAll('.matching-drop-zone').length;
                          const matchedDropZones = matchingContainer.querySelectorAll('.matching-drop-zone.matched').length;
                          
                          if (matchedDropZones < totalDropZones) {
                              alert(`–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ –≤—Å–µ —Ç–µ—Ä–º–∏–Ω—ã! (${matchedDropZones}/${totalDropZones})`);
                                  return;
                              }
                          }
                      }
                      
                      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ matching
                      const matchingMobile = document.querySelector('.matching-mobile');
                      if (matchingMobile && matchingMobile.offsetParent !== null) {
                          const selects = matchingMobile.querySelectorAll('.matching-select-mobile');
                          let allSelected = true;
                          selects.forEach(select => {
                              if (!select.value || select.value === '') {
                                  allSelected = false;
                              }
                          });
                          if (!allSelected) {
                              alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤!');
                              return;
                          }
                      }
                      
                      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ sorting
                      const sortingContainer = document.querySelector('.sorting-container');
                      if (sortingContainer) {
                          const sortableList = sortingContainer.querySelector('.list-group');
                          if (sortableList) {
                              // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ hidden inputs –¥–ª—è sorting
                              form.querySelectorAll('input[name^="sort_"]').forEach(input => input.remove());
                              
                              // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ hidden inputs —Å —Ç–µ–∫—É—â–∏–º –ø–æ—Ä—è–¥–∫–æ–º
                              const listItems = sortableList.querySelectorAll('li[data-id]');
                              listItems.forEach((item, index) => {
                                  const hiddenInput = document.createElement('input');
                                  hiddenInput.type = 'hidden';
                                  hiddenInput.name = `sort_${index}`;
                                  hiddenInput.value = item.getAttribute('data-id');
                                  form.appendChild(hiddenInput);
                              });
                          }
                      }
                      
                      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                      form.submit();
                  });
              }
              
              form.addEventListener('submit', function(e) {
                   // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤
                   const checkedRadio = document.querySelector('.quiz-radio:checked');
                   const checkedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
                   const matchingActive = document.querySelector('.matching-drop-zone.matched');
                   const sortingList = document.querySelector('.list-group');
                   
                   // –î–ª—è matching –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏)
                   const matchingDesktop = document.querySelector('.matching-desktop');
                   if (matchingDesktop && matchingDesktop.offsetParent !== null) {
                   const matchingContainer = document.querySelector('.matching-container');
                   if (matchingContainer) {
                       const totalDropZones = matchingContainer.querySelectorAll('.matching-drop-zone').length;
                       const matchedDropZones = matchingContainer.querySelectorAll('.matching-drop-zone.matched').length;
                       
                       if (matchedDropZones < totalDropZones) {
                           e.preventDefault();
                           alert(`–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ –≤—Å–µ —Ç–µ—Ä–º–∏–Ω—ã! (${matchedDropZones}/${totalDropZones})`);
                               return false;
                           }
                       }
                   }
                   
                   // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ matching
                   const matchingMobile = document.querySelector('.matching-mobile');
                   if (matchingMobile && matchingMobile.offsetParent !== null) {
                       const selects = matchingMobile.querySelectorAll('.matching-select-mobile');
                       let allSelected = true;
                       selects.forEach(select => {
                           if (!select.value || select.value === '') {
                               allSelected = false;
                           }
                       });
                       if (!allSelected) {
                           e.preventDefault();
                           alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤!');
                           return false;
                       }
                   }
                   
                   // –î–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±–æ—Ä (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ matching –∏–ª–∏ sorting)
                   const hasMatching = document.querySelector('.matching-container') !== null;
                   const hasSorting = document.querySelector('.list-group') !== null;
                   
                   // –ï—Å–ª–∏ –µ—Å—Ç—å matching –∏–ª–∏ sorting, —Ñ–æ—Ä–º–∞ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤—ã—à–µ
                   if (!checkedRadio && checkedCheckboxes.length === 0 && !hasMatching && !hasSorting) {
                       e.preventDefault();
                       alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞!');
                       return false;
                   }
                   
                   // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
                   const completionTimeField = document.getElementById('completionTime');
                   if (completionTimeField) {
                       completionTimeField.value = timeLeft;
                   }
                   
                   // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
                   stopTimer();
              });
           }
    
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    const progressBar = document.getElementById('quizProgressBar');
    if (progressBar) {
        const answered = parseInt(progressBar.dataset.answered);
        const total = parseInt(progressBar.dataset.total);
        const percentage = total > 0 ? (answered / total) * 100 : 0;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–±–∏–ª—å–Ω–∞—è –ª–∏ –≤–µ—Ä—Å–∏—è
        const isMobileView = window.matchMedia("(max-width: 768px)").matches;
        
        progressBar.style.width = percentage + '%';
        
        if (isMobileView) {
            // –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –∫–∞–∫ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –æ–±—É—á–µ–Ω–∏—è
            progressBar.style.background = 'linear-gradient(90deg, #667eea, #764ba2)';
        } else {
            // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
        progressBar.style.background = 'linear-gradient(45deg, #6366f1, #8b5cf6)';
        }
        
        setTimeout(() => {
            progressBar.style.transition = 'width 0.8s ease';
        }, 100);
    }
});

// –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    const quizCard = document.querySelector('.quiz-card');
    if (quizCard) {
        quizCard.style.opacity = '0';
        quizCard.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            quizCard.style.transition = 'all 0.5s ease';
            quizCard.style.opacity = '1';
            quizCard.style.transform = 'translateY(0)';
        }, 100);
    }
    
});
</script>


<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Å –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
function showHint() {
    const hintContent = document.getElementById('hintContent');
    const hintBtn = document.querySelector('.hint-btn');
    
    if (hintContent) {
        hintContent.style.display = 'block';
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            hintContent.style.opacity = '1';
        }, 10);
    }
    
    // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è
    if (hintBtn) {
        hintBtn.innerHTML = '<i class="fa-solid fa-eye-slash me-1"></i>–°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É';
        hintBtn.classList.remove('btn-outline-warning');
        hintBtn.classList.add('btn-warning');
        hintBtn.setAttribute('onclick', 'hideHint()');
    }
}

function hideHint() {
    const hintContent = document.getElementById('hintContent');
    const hintBtn = document.querySelector('.hint-btn');
    
    if (hintContent) {
        hintContent.style.opacity = '0';
        // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            hintContent.style.display = 'none';
        }, 300);
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
    if (hintBtn) {
        hintBtn.innerHTML = '<i class="fa-solid fa-lightbulb me-1"></i>–ü–æ–¥—Å–∫–∞–∑–∫–∞ (<span class="hint-coins">3ü™ô</span>)';
        hintBtn.classList.remove('btn-warning');
        hintBtn.classList.add('btn-outline-warning');
        hintBtn.setAttribute('onclick', 'showHint()');
    }
}
</script>

<script>
// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (drag and drop)
document.addEventListener('DOMContentLoaded', function() {
    const sortableLists = document.querySelectorAll('.list-group');
    
    sortableLists.forEach(list => {
        let draggedElement = null;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è drag and drop
        list.querySelectorAll('li[data-id]').forEach(li => {
            li.addEventListener('dragstart', function(e) {
                draggedElement = this;
                e.dataTransfer.effectAllowed = 'move';
                this.style.opacity = '0.5';
            });
            
            li.addEventListener('dragend', function(e) {
                this.style.opacity = '1';
                draggedElement = null;
            });
            
            li.addEventListener('dragover', function(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                
                if (draggedElement && this !== draggedElement) {
                    const rect = this.getBoundingClientRect();
                    const midPoint = rect.top + rect.height / 2;
                    
                    if (e.clientY < midPoint) {
                        this.parentNode.insertBefore(draggedElement, this);
                    } else {
                        this.parentNode.insertBefore(draggedElement, this.nextSibling);
                    }
                }
            });
            
            li.addEventListener('drop', function(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                return false;
            });
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–ª—è —Ç–∏–ø–∞ sorting
    // –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ - –æ–Ω —É–∂–µ –µ—Å—Ç—å –≤—ã—à–µ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 843
    const sortForm = document.getElementById('levelForm');
    if (sortForm) {
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É —Ç–æ–ª—å–∫–æ –¥–ª—è sorting
        // –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 843 —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è (drag and drop –¥–ª—è matching) - —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    const matchingContainers = document.querySelectorAll('.matching-container');
    
    if (matchingContainers.length === 0) {
        return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –Ω–µ—Ç matching –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
    const matchingMobile = document.querySelector('.matching-mobile');
    if (matchingMobile && matchingMobile.offsetParent !== null) {
        return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏
    }
    
    let draggedMatchingElement = null;
    
    matchingContainers.forEach((container, index) => {
        const draggables = container.querySelectorAll('.matching-draggable');
        const dropZones = container.querySelectorAll('.matching-drop-zone');
        
        draggables.forEach((draggable, draggableIndex) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ draggable
            if (draggable.getAttribute('draggable') !== 'true') {
                draggable.setAttribute('draggable', 'true');
            }
            
            draggable.addEventListener('dragstart', function(e) {
                draggedMatchingElement = this;
                this.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', this.getAttribute('data-left-index'));
            }, {passive: false});
            
            draggable.addEventListener('dragend', function(e) {
                this.style.opacity = '1';
                // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –±—ã–ª —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
            });
        });
        
        dropZones.forEach((zone, zoneIndex) => {
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–æ–±—ã—Ç–∏–µ drag –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            zone.querySelectorAll('*').forEach(child => {
                child.addEventListener('drag', function(e) {
                    e.stopPropagation();
                });
            });
            
            zone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';
                e.dataTransfer.effectAllowed = 'move';
                if (!this.classList.contains('drop-active')) {
                    this.classList.add('drop-active');
                }
            }, {passive: false});
            
            zone.addEventListener('dragenter', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';
                e.dataTransfer.effectAllowed = 'move';
                this.classList.add('drop-active');
            }, {passive: false});
            
            zone.addEventListener('dragleave', function(e) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–∫–∏–¥–∞–µ–º –∏–º–µ–Ω–Ω–æ —ç—Ç—É –∑–æ–Ω—É, –∞ –Ω–µ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                const rect = this.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;
                
                if (x < rect.left || x >= rect.right || y < rect.top || y >= rect.bottom) {
                    this.classList.remove('drop-active');
                }
            });
            
            zone.addEventListener('drop', function(e) {
                try {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    this.classList.remove('drop-active');
                    
                    if (draggedMatchingElement) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ —ç—Ç–∞ zone —É–∂–µ
                        if (this.classList.contains('matched')) {
                            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
                            const oldInput = this.querySelector('input[type="hidden"]');
                            if (oldInput) {
                                oldInput.value = '';
                            }
                            const dropText = this.querySelector('.drop-text');
                            dropText.innerHTML = '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–µ—Ä–º–∏–Ω —Å—é–¥–∞';
                            this.classList.remove('matched');
                        }
                        
                        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
                        const leftIndex = draggedMatchingElement.getAttribute('data-left-index');
                        const rightIndex = this.getAttribute('data-right-index');
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Ç–µ—Ä–º–∏–Ω–∞ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
                        const cardBody = draggedMatchingElement.querySelector('.card-body');
                        const termText = cardBody.innerText.trim();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑ –≥–∞–ª–æ—á–∫–∏
                        const dropText = this.querySelector('.drop-text');
                        dropText.innerHTML = `<span style="color: #7b1fa2; font-weight: 600;">${termText}</span>`;
                        
                        // –ù–∞—Ö–æ–¥–∏–º hidden input –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–π zone
                        const hiddenInput = this.querySelector('input[type="hidden"]');
                        if (hiddenInput) {
                            hiddenInput.value = leftIndex;
                        }
                        
                        // –í–∏–∑—É–∞–ª—å–Ω–æ –æ—Ç–º–µ—á–∞–µ–º, —á—Ç–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
                        this.classList.add('matched');
                        draggedMatchingElement.classList.add('matched');
                        
                        // –î–µ–ª–∞–µ–º draggable —Å–µ—Ä—ã–º, –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –∏ –Ω–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º
                        draggedMatchingElement.style.opacity = '0.4';
                        draggedMatchingElement.style.filter = 'grayscale(100%)';
                        draggedMatchingElement.setAttribute('draggable', 'false');
                        
                        // –¢–∞–∫–∂–µ –¥–µ–ª–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ä–æ–π
                        const card = draggedMatchingElement.querySelector('.card');
                        if (card) {
                            card.style.backgroundColor = '#e0e0e0';
                            card.style.color = '#757575';
                        }
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º opacity –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                        draggedMatchingElement = null;
                    }
                } catch (error) {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Ç–∏—Ö–æ
                }
                
                return false;
            });
        });
    });
});
</script>

{% endblock %}
