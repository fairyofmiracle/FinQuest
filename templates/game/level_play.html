{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <a href="{% url 'topic_levels' level.topic.id %}" class="btn btn-sm btn-outline-secondary">
    <i class="fa-solid fa-arrow-left me-1"></i>–ö —Ç–µ–º–µ
  </a>
  <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-primary">
    <i class="fa-solid fa-home me-1"></i>–î–∞—à–±–æ—Ä–¥
  </a>
  <div></div>
</div>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–Ω—è —Å –∏–∫–æ–Ω–∫–æ–π —Ç–∏–ø–∞ -->
<div class="level-header mb-4">
  <div class="d-flex align-items-center mb-2">
    <span class="level-type-badge me-3">
      {% if level.type == 'quiz' %}üìù
      {% elif level.type == 'scenario' %}üé≠
      {% elif level.type == 'calculation' %}üßÆ
      {% elif level.type == 'matching' %}üîó
      {% elif level.type == 'sorting' %}üìä
      {% elif level.type == 'simulation' %}üéÆ
      {% else %}‚ùì{% endif %}
    </span>
    <h4 class="mb-0">{{ level.title }}</h4>
  </div>
  <p class="text-muted">{{ level.description|linebreaks }}</p>
</div>

<!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
{% if hint %}
  {% if hint_shown %}
    <div class="alert alert-info">üí° {{ hint.text }}</div>
  {% else %}
    <form method="post" class="mb-3">
      {% csrf_token %}
      <input type="hidden" name="action" value="buy_hint">
      <button type="submit" class="btn btn-outline-info btn-sm">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É (‚àí{{ hint.cost_coins }} ü™ô)</button>
    </form>
  {% endif %}
{% endif %}

<!-- –ö–æ–Ω—Ç–µ–Ω—Ç —É—Ä–æ–≤–Ω—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ -->
{% if level.type == 'quiz' %}
  <!-- –ö–≤–∏–∑ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) -->
  <form method="post">
    {% csrf_token %}
    {% for option in options %}
      <div class="form-check mb-2">
        <input class="form-check-input" type="radio" name="answer" value="{{ option.id }}" id="opt{{ option.id }}" required>
        <label class="form-check-label" for="opt{{ option.id }}">{{ option.text }}</label>
      </div>
    {% empty %}
      <p class="text-muted">–ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞.</p>
    {% endfor %}
    <button type="submit" class="btn btn-success btn-lg mt-3 w-100">
      <i class="fa-solid fa-check me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å
    </button>
  </form>

{% elif level.type == 'scenario' %}
  <!-- –°—Ü–µ–Ω–∞—Ä–∏–π -->
  <div class="scenario-level">
    <div class="scenario-content mb-4">
      <h5>{{ level.content.scenario }}</h5>
      {% if level.content.situation %}
        <div class="situation-info p-3 bg-light rounded mb-3">
          <h6>–°–∏—Ç—É–∞—Ü–∏—è:</h6>
          <ul class="mb-0">
            <li>–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞: {{ level.content.situation.current_amount|floatformat:0 }} ‚ÇΩ</li>
            <li>–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞: {{ level.content.situation.target_amount|floatformat:0 }} ‚ÇΩ</li>
            <li>–°—Ä–æ–∫: {{ level.content.situation.timeframe }} –º–µ—Å—è—Ü–µ–≤</li>
          </ul>
        </div>
      {% endif %}
    </div>
    
    <form method="post">
      {% csrf_token %}
      <h6>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç:</h6>
      {% for option in level.content.options %}
        <div class="form-check mb-3">
          <input class="form-check-input" type="radio" name="scenario_answer" value="{{ forloop.counter0 }}" id="scenario{{ forloop.counter0 }}" required>
          <label class="form-check-label" for="scenario{{ forloop.counter0 }}">
            <div class="option-card p-3 border rounded">
              <h6>{{ option.bank }}</h6>
              <p class="mb-1"><strong>–°—Ç–∞–≤–∫–∞:</strong> {{ option.rate }}% –≥–æ–¥–æ–≤—ã—Ö</p>
              <p class="mb-1"><strong>–ú–∏–Ω. —Å—É–º–º–∞:</strong> {{ option.min_amount|floatformat:0 }} ‚ÇΩ</p>
              <p class="mb-0 text-muted">{{ option.description }}</p>
            </div>
          </label>
        </div>
      {% endfor %}
      <button type="submit" class="btn btn-success btn-lg mt-3 w-100">
        <i class="fa-solid fa-check me-2"></i>–í—ã–±—Ä–∞—Ç—å
      </button>
    </form>
  </div>

{% elif level.type == 'calculation' %}
  <!-- –†–∞—Å—á–µ—Ç—ã -->
  <div class="calculation-level">
    <div class="calculation-content mb-4">
      <h5>{{ level.content.task }}</h5>
      {% if level.content.formula %}
        <div class="formula-box p-3 bg-light rounded mb-3">
          <h6>–§–æ—Ä–º—É–ª–∞:</h6>
          <code>{{ level.content.formula }}</code>
        </div>
      {% endif %}
      {% if level.content.given %}
        <div class="given-data p-3 bg-info bg-opacity-10 rounded mb-3">
          <h6>–î–∞–Ω–æ:</h6>
          <ul class="mb-0">
            {% for key, value in level.content.given.items %}
              <li><strong>{{ key }}:</strong> {{ value }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      {% if level.content.steps %}
        <div class="steps p-3 bg-warning bg-opacity-10 rounded mb-3">
          <h6>–®–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è:</h6>
          <ol class="mb-0">
            {% for step in level.content.steps %}
              <li>{{ step }}</li>
            {% endfor %}
          </ol>
        </div>
      {% endif %}
    </div>
    
    <form method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label for="calculation_answer" class="form-label">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
        <input type="number" class="form-control form-control-lg" id="calculation_answer" name="calculation_answer" step="0.01" required>
        <div class="form-text">–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π –æ—Ç–≤–µ—Ç (–¥–æ–ø—É—Å—Ç–∏–º–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å: ¬±{{ level.content.tolerance|floatformat:0 }})</div>
      </div>
      <button type="submit" class="btn btn-success btn-lg w-100">
        <i class="fa-solid fa-calculator me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç
      </button>
    </form>
  </div>

{% elif level.type == 'matching' %}
  <!-- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ -->
  <div class="matching-level">
    <h5>{{ level.content.instruction }}</h5>
    <form method="post">
      {% csrf_token %}
      <div class="row">
        <div class="col-md-6">
          <h6>–¢–µ—Ä–º–∏–Ω—ã:</h6>
          {% for item in level.content.items %}
            <div class="matching-item p-2 border rounded mb-2" data-left="{{ forloop.counter0 }}">
              {{ item.left }}
            </div>
          {% endfor %}
        </div>
        <div class="col-md-6">
          <h6>–û–ø–∏—Å–∞–Ω–∏—è:</h6>
          {% for item in level.content.items %}
            <select name="match_{{ forloop.counter0 }}" class="form-select mb-2" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ</option>
              {% for desc_item in level.content.items %}
                <option value="{{ forloop.counter0 }}">{{ desc_item.right }}</option>
              {% endfor %}
            </select>
          {% endfor %}
        </div>
      </div>
      <button type="submit" class="btn btn-success btn-lg mt-3 w-100">
        <i class="fa-solid fa-link me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
      </button>
    </form>
  </div>

{% elif level.type == 'sorting' %}
  <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
  <div class="sorting-level">
    <h5>{{ level.content.instruction }}</h5>
    <form method="post">
      {% csrf_token %}
      <div class="sortable-list">
        {% for item in level.content.items %}
          <div class="sortable-item p-3 border rounded mb-2" data-order="{{ forloop.counter0 }}">
            <div class="d-flex justify-content-between align-items-center">
              <span>{{ item }}</span>
              <select name="sort_{{ forloop.counter0 }}" class="form-select" style="width: auto;" required>
                <option value="">–ü–æ–∑–∏—Ü–∏—è</option>
                {% for i in level.content.items %}
                  <option value="{{ forloop.counter0 }}">{{ forloop.counter }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        {% endfor %}
      </div>
      <button type="submit" class="btn btn-success btn-lg mt-3 w-100">
        <i class="fa-solid fa-sort me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫
      </button>
    </form>
  </div>

{% elif level.type == 'simulation' %}
  <!-- –°–∏–º—É–ª—è—Ü–∏—è -->
  <div class="simulation-level">
    <div class="simulation-content mb-4">
      <h5>{{ level.content.scenario }}</h5>
      {% if level.content.dialogue %}
        <div class="dialogue-box p-3 bg-light rounded mb-3">
          {% for message in level.content.dialogue %}
            <div class="message mb-3">
              <div class="speaker text-primary fw-bold">{{ message.speaker }}:</div>
              <div class="message-text">{{ message.text }}</div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    
    <form method="post">
      {% csrf_token %}
      <h6>–í–∞—à –æ—Ç–≤–µ—Ç:</h6>
      {% for dialogue in level.content.dialogue %}
        {% for response in dialogue.responses %}
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="simulation_response" value="{{ forloop.counter0 }}" id="sim{{ forloop.counter0 }}" required>
            <label class="form-check-label" for="sim{{ forloop.counter0 }}">
              <div class="response-card p-3 border rounded">
                {{ response.text }}
              </div>
            </label>
          </div>
        {% endfor %}
      {% endfor %}
      <button type="submit" class="btn btn-success btn-lg mt-3 w-100">
        <i class="fa-solid fa-play me-2"></i>–û—Ç–≤–µ—Ç–∏—Ç—å
      </button>
    </form>
  </div>

{% else %}
  <!-- –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —É—Ä–æ–≤–Ω—è -->
  <div class="alert alert-warning">
    <h5>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —É—Ä–æ–≤–Ω—è</h5>
    <p>–≠—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å –∏–º–µ–µ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø: {{ level.type }}</p>
  </div>
{% endif %}

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-3" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}
{% endblock %}