{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 desktop-nav">
  <a href="{% url 'topic_levels' level.topic.id %}" class="btn btn-sm btn-outline-secondary">
    <i class="fa-solid fa-arrow-left me-1"></i>–ö —Ç–µ–º–µ
  </a>
  <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-primary">
    <i class="fa-solid fa-home me-1"></i>–î–∞—à–±–æ—Ä–¥
  </a>
  <div></div>
</div>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–Ω—è —Å –∏–∫–æ–Ω–∫–æ–π —Ç–∏–ø–∞ -->
<div class="level-header mb-4">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex align-items-center">
      <span class="level-type-badge me-3">
        {% if level.type == 'quiz' %}üìù
        {% elif level.type == 'scenario' %}üé≠
        {% elif level.type == 'calculation' %}üßÆ
        {% elif level.type == 'matching' %}üîó
        {% elif level.type == 'sorting' %}üìä
        {% elif level.type == 'simulation' %}üéÆ
        {% else %}‚ùì{% endif %}
      </span>
      <h4 class="mb-0">{{ level.title }}</h4>
    </div>
    
    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–ø—Ä–∞–≤–∞ (–∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞) -->
    {% if hint %}
      {% if not hint_shown %}
        <form method="post" style="margin: 0;">
          {% csrf_token %}
          <input type="hidden" name="action" value="buy_hint">
          <button type="submit" class="btn btn-sm btn-outline-info hint-btn-compact haptic-medium" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞">
            <i class="fa-solid fa-lightbulb"></i>
            <span class="badge bg-warning text-dark ms-1">{{ hint.cost_coins }}</span>
          </button>
        </form>
      {% endif %}
    {% endif %}
  </div>
  <p class="text-muted">{{ level.description|linebreaks }}</p>
  
  <!-- –ü–æ–∫–∞–∑–∞–Ω–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º -->
  {% if hint and hint_shown %}
    <div class="alert alert-info hint-shown mt-3">
      <div class="hint-icon">üí°</div>
      <div class="hint-text">{{ hint.text }}</div>
    </div>
  {% endif %}
</div>

<!-- –ö–æ–Ω—Ç–µ–Ω—Ç —É—Ä–æ–≤–Ω—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ -->
{% if level.type == 'quiz' %}
  <!-- –ö–≤–∏–∑ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç) -->
  <form method="post">
    {% csrf_token %}
    {% for option in options %}
      <div class="form-check mb-2">
        <input class="form-check-input" type="radio" name="answer" value="{{ option.id }}" id="opt{{ option.id }}" required>
        <label class="form-check-label" for="opt{{ option.id }}">{{ option.text }}</label>
      </div>
    {% empty %}
      <p class="text-muted">–ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞.</p>
    {% endfor %}
    <button type="submit" class="btn btn-success btn-lg mt-3 w-100 haptic-medium">
      <i class="fa-solid fa-check me-2"></i>–û—Ç–≤–µ—Ç–∏—Ç—å
    </button>
  </form>

{% elif level.type == 'scenario' %}
  <!-- –°—Ü–µ–Ω–∞—Ä–∏–π -->
  <div class="scenario-level">
    <div class="scenario-content mb-4">
      <h5>{{ level.content.scenario }}</h5>
      {% if level.content.situation %}
        <div class="situation-info p-3 bg-light rounded mb-3">
          <h6>–°–∏—Ç—É–∞—Ü–∏—è:</h6>
          <ul class="mb-0">
            <li>–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞: {{ level.content.situation.current_amount|floatformat:0 }} ‚ÇΩ</li>
            <li>–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞: {{ level.content.situation.target_amount|floatformat:0 }} ‚ÇΩ</li>
            <li>–°—Ä–æ–∫: {{ level.content.situation.timeframe }} –º–µ—Å—è—Ü–µ–≤</li>
          </ul>
        </div>
      {% endif %}
    </div>
    
    <form method="post">
      {% csrf_token %}
      <h6>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç:</h6>
      {% for option in level.content.options %}
        <div class="form-check mb-3">
          <input class="form-check-input" type="radio" name="scenario_answer" value="{{ forloop.counter0 }}" id="scenario{{ forloop.counter0 }}" required>
          <label class="form-check-label" for="scenario{{ forloop.counter0 }}">
            <div class="option-card p-3 border rounded">
              <h6>{{ option.bank }}</h6>
              <p class="mb-1"><strong>–°—Ç–∞–≤–∫–∞:</strong> {{ option.rate }}% –≥–æ–¥–æ–≤—ã—Ö</p>
              <p class="mb-1"><strong>–ú–∏–Ω. —Å—É–º–º–∞:</strong> {{ option.min_amount|floatformat:0 }} ‚ÇΩ</p>
              <p class="mb-0 text-muted">{{ option.description }}</p>
            </div>
          </label>
        </div>
      {% endfor %}
      <button type="submit" class="btn btn-success btn-lg mt-3 w-100 haptic-medium">
        <i class="fa-solid fa-check me-2"></i>–û—Ç–≤–µ—Ç–∏—Ç—å
      </button>
    </form>
  </div>

{% elif level.type == 'calculation' %}
  <!-- –†–∞—Å—á–µ—Ç—ã -->
  <div class="calculation-level">
    <div class="calculation-content mb-4">
      <h5>{{ level.content.task }}</h5>
      {% if level.content.formula %}
        <div class="formula-box p-3 bg-light rounded mb-3">
          <h6>–§–æ—Ä–º—É–ª–∞:</h6>
          <code>{{ level.content.formula }}</code>
        </div>
      {% endif %}
      {% if level.content.given %}
        <div class="given-data p-3 bg-info bg-opacity-10 rounded mb-3">
          <h6>–î–∞–Ω–æ:</h6>
          <ul class="mb-0">
            {% for key, value in level.content.given.items %}
              <li><strong>{{ key }}:</strong> {{ value }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      {% if level.content.steps %}
        <div class="steps p-3 bg-warning bg-opacity-10 rounded mb-3">
          <h6>–®–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è:</h6>
          <ol class="mb-0">
            {% for step in level.content.steps %}
              <li>{{ step }}</li>
            {% endfor %}
          </ol>
        </div>
      {% endif %}
    </div>
    
    <form method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label for="calculation_answer" class="form-label">–í–∞—à –æ—Ç–≤–µ—Ç:</label>
        <input type="number" class="form-control form-control-lg" id="calculation_answer" name="calculation_answer" step="0.01" required>
        <div class="form-text">–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ–≤–æ–π –æ—Ç–≤–µ—Ç (–¥–æ–ø—É—Å—Ç–∏–º–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å: ¬±{{ level.content.tolerance|floatformat:0 }})</div>
      </div>
      <button type="submit" class="btn btn-success btn-lg w-100 haptic-medium">
        <i class="fa-solid fa-calculator me-2"></i>–û—Ç–≤–µ—Ç–∏—Ç—å
      </button>
    </form>
  </div>

{% elif level.type == 'matching' %}
  <!-- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ -->
  <div class="matching-level">
    <div class="matching-instruction mb-3">
      <h5>{{ level.content.instruction }}</h5>
      <p class="text-muted small mb-0">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞</p>
    </div>
    <form method="post">
      {% csrf_token %}
      
      <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏ -->
      <div class="matching-cards">
        {% for item in level.content.items %}
          <div class="matching-card mb-3">
            <div class="matching-term">
              <span class="term-number">{{ forloop.counter }}</span>
              <span class="term-text">{{ item.left }}</span>
            </div>
            <div class="matching-select-wrapper">
              <label class="form-label small text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</label>
              <select name="match_{{ forloop.counter0 }}" class="form-select" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                {% for desc_item in level.content.items %}
                  <option value="{{ forloop.counter0 }}">{{ desc_item.right }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        {% endfor %}
      </div>
      
      <button type="submit" class="btn btn-success btn-lg mt-3 w-100 haptic-medium">
        <i class="fa-solid fa-link me-2"></i>–û—Ç–≤–µ—Ç–∏—Ç—å
      </button>
    </form>
  </div>

{% elif level.type == 'sorting' %}
  <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
  <div class="sorting-level">
    <h5>{{ level.content.instruction }}</h5>
    <form method="post">
      {% csrf_token %}
      <div class="sortable-list">
        {% for item in level.content.items %}
          <div class="sortable-item p-3 border rounded mb-2" data-order="{{ forloop.counter0 }}">
            <div class="d-flex justify-content-between align-items-center">
              <span>{{ item }}</span>
              <select name="sort_{{ forloop.counter0 }}" class="form-select" style="width: auto;" required>
                <option value="">–ü–æ–∑–∏—Ü–∏—è</option>
                {% for i in level.content.items %}
                  <option value="{{ forloop.counter0 }}">{{ forloop.counter }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        {% endfor %}
      </div>
      <button type="submit" class="btn btn-success btn-lg mt-3 w-100 haptic-medium">
        <i class="fa-solid fa-sort me-2"></i>–û—Ç–≤–µ—Ç–∏—Ç—å
      </button>
    </form>
  </div>

{% elif level.type == 'simulation' %}
  <!-- –°–∏–º—É–ª—è—Ü–∏—è -->
  <div class="simulation-level">
    <div class="simulation-content mb-4">
      <h5>{{ level.content.scenario }}</h5>
      {% if level.content.dialogue %}
        <div class="dialogue-box p-3 bg-light rounded mb-3">
          {% for message in level.content.dialogue %}
            <div class="message mb-3">
              <div class="speaker text-primary fw-bold">{{ message.speaker }}:</div>
              <div class="message-text">{{ message.text }}</div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
    
    <form method="post">
      {% csrf_token %}
      <h6>–í–∞—à –æ—Ç–≤–µ—Ç:</h6>
      {% for dialogue in level.content.dialogue %}
        {% for response in dialogue.responses %}
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="simulation_response" value="{{ forloop.counter0 }}" id="sim{{ forloop.counter0 }}" required>
            <label class="form-check-label" for="sim{{ forloop.counter0 }}">
              <div class="response-card p-3 border rounded">
                {{ response.text }}
              </div>
            </label>
          </div>
        {% endfor %}
      {% endfor %}
      <button type="submit" class="btn btn-success btn-lg mt-3 w-100 haptic-medium">
        <i class="fa-solid fa-play me-2"></i>–û—Ç–≤–µ—Ç–∏—Ç—å
      </button>
    </form>
  </div>

{% else %}
  <!-- –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —É—Ä–æ–≤–Ω—è -->
  <div class="alert alert-warning">
    <h5>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —É—Ä–æ–≤–Ω—è</h5>
    <p>–≠—Ç–æ—Ç —É—Ä–æ–≤–µ–Ω—å –∏–º–µ–µ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø: {{ level.type }}</p>
  </div>
{% endif %}

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-3" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}

<style>
/* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è */
@media (max-width: 768px) {
  /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  body.mobile-view .desktop-nav {
    display: none !important;
  }
  
  /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–Ω—è */
  body.mobile-view .level-header {
    padding: 1rem;
    margin: 0 -0.5rem 1rem -0.5rem;
  }
  
  body.mobile-view .level-header h4 {
    font-size: 1.1rem;
  }
  
  body.mobile-view .level-type-badge {
    font-size: 1.5rem;
  }
  
  /* –£–º–µ–Ω—å—à–∞–µ–º padding —É –∫–∞—Ä—Ç–æ—á–µ–∫ */
  body.mobile-view .option-card,
  body.mobile-view .response-card,
  body.mobile-view .situation-info,
  body.mobile-view .formula-box,
  body.mobile-view .given-data,
  body.mobile-view .steps,
  body.mobile-view .dialogue-box {
    padding: 0.75rem !important;
    border-radius: 12px !important;
  }
  
  body.mobile-view .option-card h6,
  body.mobile-view .response-card h6 {
    font-size: 0.95rem !important;
  }
  
  /* –§–æ—Ä–º—ã */
  body.mobile-view .form-check {
    margin-bottom: 0.75rem !important;
  }
  
  body.mobile-view .form-check-label {
    font-size: 0.95rem;
  }
  
  body.mobile-view .form-control,
  body.mobile-view .form-select {
    font-size: 1rem !important;
    padding: 0.75rem !important;
    border-radius: 12px !important;
  }
  
  /* –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ - –ø–æ —Ü–µ–Ω—Ç—Ä—É */
  body.mobile-view .btn-success,
  body.mobile-view .btn-primary {
    padding: 1rem !important;
    font-size: 1rem !important;
    border-radius: 16px !important;
    font-weight: 700 !important;
    display: block !important;
    margin: 0 auto !important;
    text-align: center !important;
  }
  
  body.mobile-view .btn-success:active,
  body.mobile-view .btn-primary:active {
    transform: scale(0.98);
  }
  
  /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å–ø—Ä–∞–≤–∞ –æ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
  body.mobile-view .hint-btn-compact {
    padding: 0.5rem 0.75rem !important;
    font-size: 0.85rem !important;
  }
  
  body.mobile-view .hint-btn-compact .badge {
    font-size: 0.7rem;
  }
  
  /* –ü–æ–¥—Å–∫–∞–∑–∫–∏ */
  body.mobile-view .alert {
    padding: 0.75rem !important;
    border-radius: 12px !important;
    font-size: 0.9rem !important;
  }
  
  body.mobile-view .hint-shown {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    background: linear-gradient(135deg, rgba(13, 202, 240, 0.1), rgba(13, 110, 253, 0.1)) !important;
    border: 2px solid #0dcaf0 !important;
    padding: 0.875rem !important;
  }
  
  body.mobile-view .hint-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }
  
  body.mobile-view .hint-text {
    flex: 1;
    font-size: 0.85rem;
  }
  
  /* –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (matching) –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
  body.mobile-view .matching-instruction h5 {
    font-size: 1rem !important;
    margin-bottom: 0.5rem !important;
  }
  
  body.mobile-view .matching-card {
    background: white;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: 16px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }
  
  body.dark-theme .matching-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(51, 65, 85, 0.92) 100%);
    border-color: #475569;
  }
  
  body.mobile-view .matching-term {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
  }
  
  body.dark-theme .matching-term {
    border-bottom-color: #475569;
  }
  
  body.mobile-view .term-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.9rem;
    flex-shrink: 0;
  }
  
  body.mobile-view .term-text {
    font-size: 0.95rem;
    font-weight: 600;
    flex: 1;
  }
  
  body.mobile-view .matching-select-wrapper .form-label {
    margin-bottom: 0.5rem;
    font-size: 0.8rem !important;
  }
  
  body.mobile-view .matching-select-wrapper .form-select {
    font-size: 0.9rem !important;
    padding: 0.75rem !important;
    border-radius: 12px !important;
    border-width: 2px !important;
  }
  
  /* –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */
  body.mobile-view .sortable-item {
    padding: 0.75rem !important;
    border-radius: 12px !important;
  }
  
  body.mobile-view .sortable-item .form-select {
    font-size: 0.85rem !important;
    padding: 0.5rem !important;
  }
  
  /* –†–∞—Å—á–µ—Ç—ã */
  body.mobile-view .calculation-level h5 {
    font-size: 1rem !important;
  }
  
  body.mobile-view .calculation-level h6 {
    font-size: 0.9rem !important;
  }
  
  body.mobile-view .formula-box code {
    font-size: 0.85rem;
  }
  
  /* –°–∏–º—É–ª—è—Ü–∏—è */
  body.mobile-view .message {
    margin-bottom: 1rem !important;
  }
  
  body.mobile-view .speaker {
    font-size: 0.9rem !important;
  }
  
  body.mobile-view .message-text {
    font-size: 0.85rem;
  }
  
  /* –°—Ü–µ–Ω–∞—Ä–∏–∏ */
  body.mobile-view .scenario-content h5 {
    font-size: 1rem !important;
  }
  
  body.mobile-view .situation-info li {
    font-size: 0.9rem;
  }
  
  /* –û–±—â–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
  body.mobile-view {
    padding: 0.5rem !important;
  }
  
  body.mobile-view form {
    margin-bottom: 1rem;
  }
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –æ–ø—Ü–∏–π */
.option-card,
.response-card {
  transition: all 0.2s ease;
  cursor: pointer;
  background: white !important;
}

body.dark-theme .option-card,
body.dark-theme .response-card {
  background: rgba(255, 255, 255, 0.05) !important;
}

.form-check-input:checked ~ .form-check-label .option-card,
.form-check-input:checked ~ .form-check-label .response-card {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15)) !important;
  border-color: #667eea !important;
  border-width: 2px !important;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25) !important;
}

body.mobile-view .option-card:active,
body.mobile-view .response-card:active {
  transform: scale(0.98);
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Å–ø—Ä–∞–≤–∞ */
.hint-btn-compact {
  padding: 0.4rem 0.75rem !important;
  border-radius: 12px !important;
  font-size: 0.9rem !important;
  border-width: 2px !important;
}

.hint-btn-compact .badge {
  font-size: 0.7rem;
  padding: 0.2rem 0.4rem;
}

/* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
body.dark-theme .situation-info,
body.dark-theme .formula-box,
body.dark-theme .given-data,
body.dark-theme .steps,
body.dark-theme .dialogue-box {
  background: rgba(255, 255, 255, 0.05) !important;
  border-color: #475569 !important;
}

body.dark-theme .option-card,
body.dark-theme .response-card,
body.dark-theme .matching-item,
body.dark-theme .sortable-item {
  background: rgba(255, 255, 255, 0.05);
  border-color: #475569 !important;
}
</style>

{% endblock %}